/* globals OwAd */import settings from'../../settings.js';import{source}from'../lib/core.js';let ads;overwolf.extensions.onUncaughtException.addListener((message,functionName,scriptName)=>{console.log('onUncaughtException',message,functionName,scriptName),(message.includes('Cannot read property')||message.includes('VPAIDLoader'))&&(console.log('closed ad'),adsError())}),window.onerror=(message,url,line,col,error)=>{console.log('window.onerror',message,url,line,col,error),message.includes('adLoadError')&&(console.log('closed ad'),adsError())};let showAdsInLoop=!1;const ADS_ACTIONS={PLAYER_LOADED:'PLAYER_LOADED',PLAY:'PLAY',IMPRESSION:'IMPRESSION',COMPLETE:'COMPLETE',ERROR:'ERROR',SHOW:'SHOW',HIDE:'HIDE'};let adsTimeoutMultiplier=1,lastAction=null;const handleAdsAction=action=>{console.log(`Ads ${action} fallback`),lastAction===action?(adsTimeoutMultiplier++,console.log('increase ads timeout multiplier',adsTimeoutMultiplier)):(adsTimeoutMultiplier=1,lastAction=action),showAdsInLoop||hideAds(),ads&&refreshAd()},refreshAd=()=>{console.log('refreshAd'),ads.refreshAd()};let lastAdsTimeout=null;const setLastAdsAction=action=>{(clearTimeout(lastAdsTimeout),!!ads)&&(action===ADS_ACTIONS.PLAYER_LOADED?lastAdsTimeout=setTimeout(()=>{handleAdsAction(action)},18e4*adsTimeoutMultiplier):action===ADS_ACTIONS.ERROR?lastAdsTimeout=setTimeout(()=>{handleAdsAction(action)},12e4*adsTimeoutMultiplier):action===ADS_ACTIONS.PLAY?lastAdsTimeout=setTimeout(()=>{handleAdsAction(action)},61e3*adsTimeoutMultiplier):action===ADS_ACTIONS.IMPRESSION?lastAdsTimeout=setTimeout(()=>{handleAdsAction(action)},61e3*adsTimeoutMultiplier):action===ADS_ACTIONS.COMPLETE?lastAdsTimeout=setTimeout(()=>{handleAdsAction(action)},18e4*adsTimeoutMultiplier):void 0)},adsPlayerLoaded=(...props)=>{console.log('adsPlayerLoaded',props),setLastAdsAction(ADS_ACTIONS.PLAYER_LOADED),source.postMessage({overwolf:!0,type:'adsPlayerLoaded'},settings.domain)},adsPlay=(...props)=>{console.log('adsPlay',props);var container=document.getElementById('main-ads');container.style.display='block',container.style.pointerEvents=null,setLastAdsAction(ADS_ACTIONS.PLAY),source.postMessage({overwolf:!0,type:'adsPlay'},settings.domain)},adsImpression=(...props)=>{if(console.log('adsImpression',props),ads){var button=document.getElementById('main-ads-button');button.style.display='block'}setLastAdsAction(ADS_ACTIONS.IMPRESSION),source.postMessage({overwolf:!0,type:'adsImpression'},settings.domain)},adsComplete=(...props)=>{console.log('adsComplete',props),showAdsInLoop||hideAds(),setLastAdsAction(ADS_ACTIONS.COMPLETE),hideCloseButton(),source.postMessage({overwolf:!0,type:'adsComplete'},settings.domain)},adsError=(...props)=>{console.log('adsError',props),setLastAdsAction(ADS_ACTIONS.ERROR),hideCloseButton(),source.postMessage({overwolf:!0,type:'adsError'},settings.domain)},closeAds=()=>{console.log('closeAds'),source.postMessage({overwolf:!0,type:'closeAds'},settings.domain),hideAds()};window.closeAds=closeAds;const hideCloseButton=()=>{// hide close button
var container=document.getElementById('main-ads');container.style.display='none',container.style.pointerEvents='none';var button=document.getElementById('main-ads-button');button.style.display='none'};export const showAds=()=>{if(console.log(`showAds ads:${!!ads}`),showAdsInLoop=!0,!ads){var container=document.getElementById('main-ads'),div=document.createElement('div');container.appendChild(div),ads=new OwAd(div),ads.addEventListener('player_loaded',adsPlayerLoaded),ads.addEventListener('play',adsPlay),ads.addEventListener('impression',adsImpression),ads.addEventListener('complete',adsComplete),ads.addEventListener('error',adsError)}};window.showAds=showAds;export const hideAds=()=>{console.log('hideAds');var container=document.getElementById('main-ads');container.style.display='none',container.style.pointerEvents='none';var button=document.getElementById('main-ads-button');button.style.display='none',ads&&(ads.removeAd(),ads=void 0)};window.hideAds=hideAds;export const avoidMoreAds=()=>{console.log('avoidMoreAds'),showAdsInLoop=!1};window.avoidMoreAds=avoidMoreAds;